// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema", "driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["budgeting"]
}

// Profile model for pseudonymization
// Maps Supabase auth.users to anonymous profile_token
model Profile {
  id           Int    @id @default(autoincrement())
  authUserId   String @unique @map("auth_user_id") @db.Uuid
  profileToken String @unique @map("profile_token")
  createdAt    Int    @map("created_at")
  updatedAt    Int    @map("updated_at")

  // Transaction Tracker mode
  transactionMonths TransactionMonth[]

  // Yearly Overview mode
  yearlyBudgets YearlyBudget[]

  @@map("profiles")
  @@schema("budgeting")
}

model TransactionMonth {
  id           Int     @id @default(autoincrement())
  profileToken String? @map("profile_token") // References profile for data ownership
  name         String  @map("month_name")
  year         Int
  month        Int     @default(1) // Month number 1-12
  income       Int     @default(0) // Stored in cents
  createdAt    Int     @map("created_at") // Unix timestamp in seconds
  updatedAt    Int     @map("updated_at") // Unix timestamp in seconds

  profile       Profile?                   @relation(fields: [profileToken], references: [profileToken], onDelete: Cascade)
  fixedPayments TransactionFixedPayment[]
  categories    TransactionCategory[]

  @@unique([profileToken, name, year])
  @@map("transaction_months")
  @@schema("budgeting")
}

model TransactionFixedPayment {
  id         Int    @id @default(autoincrement())
  monthId    Int    @map("month_id")
  name       String
  amount     Int    // Stored in cents
  orderIndex Int    @default(0) @map("order_index")
  createdAt  Int    @map("created_at") // Unix timestamp in seconds
  updatedAt  Int    @map("updated_at") // Unix timestamp in seconds

  month TransactionMonth @relation(fields: [monthId], references: [id], onDelete: Cascade)

  @@index([monthId])
  @@map("transaction_fixed_payments")
  @@schema("budgeting")
}

model TransactionCategory {
  id              Int    @id @default(autoincrement())
  monthId         Int    @map("month_id")
  name            String
  allocatedAmount Int    @default(0) @map("allocated_amount") // Stored in cents
  orderIndex      Int    @default(0) @map("order_index")
  createdAt       Int    @map("created_at") // Unix timestamp in seconds
  updatedAt       Int    @map("updated_at") // Unix timestamp in seconds

  month        TransactionMonth   @relation(fields: [monthId], references: [id], onDelete: Cascade)
  transactions TransactionEntry[]

  @@index([monthId])
  @@map("transaction_categories")
  @@schema("budgeting")
}

model TransactionEntry {
  id              Int     @id @default(autoincrement())
  categoryId      Int     @map("category_id")
  amount          Int     // Stored in cents
  description     String?
  transactionDate Int?    @map("transaction_date") // Unix timestamp in seconds
  createdAt       Int     @map("created_at") // Unix timestamp in seconds
  updatedAt       Int     @map("updated_at") // Unix timestamp in seconds

  category TransactionCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@map("transaction_entries")
  @@schema("budgeting")
}

// ============================================
// YEARLY OVERVIEW MODE MODELS
// ============================================

enum SectionType {
  LIVING
  NON_ESSENTIAL
  SAVINGS

  @@schema("budgeting")
}

// Yearly budget for a specific year
model YearlyBudget {
  id           Int     @id @default(autoincrement())
  profileToken String? @map("profile_token") // References profile for data ownership
  year         Int
  spendTarget  Int     @default(500000) @map("spend_target") // Target discretionary spend in cents (R5000)
  showWarnings Boolean @default(true) @map("show_warnings") // Color warnings toggle
  createdAt    Int     @map("created_at")
  updatedAt    Int     @map("updated_at")

  profile       Profile?             @relation(fields: [profileToken], references: [profileToken], onDelete: Cascade)
  incomeSources YearlyIncomeSource[]
  sections      YearlySection[]

  @@unique([profileToken, year])
  @@map("yearly_budgets")
  @@schema("budgeting")
}

// Income source (Salary, Side Hustle, etc.)
model YearlyIncomeSource {
  id             Int    @id @default(autoincrement())
  yearlyBudgetId Int    @map("yearly_budget_id")
  name           String
  orderIndex     Int    @default(0) @map("order_index")
  createdAt      Int    @map("created_at")
  updatedAt      Int    @map("updated_at")

  yearlyBudget YearlyBudget        @relation(fields: [yearlyBudgetId], references: [id], onDelete: Cascade)
  entries      YearlyIncomeEntry[]

  @@index([yearlyBudgetId])
  @@map("yearly_income_sources")
  @@schema("budgeting")
}

// Monthly income entry (gross amount per month)
model YearlyIncomeEntry {
  id             Int @id @default(autoincrement())
  incomeSourceId Int @map("income_source_id")
  month          Int // 1-12
  grossAmount    Int @default(0) @map("gross_amount") // In cents
  createdAt      Int @map("created_at")
  updatedAt      Int @map("updated_at")

  incomeSource YearlyIncomeSource @relation(fields: [incomeSourceId], references: [id], onDelete: Cascade)
  deductions   YearlyDeduction[]

  @@index([incomeSourceId])
  @@unique([incomeSourceId, month])
  @@map("yearly_income_entries")
  @@schema("budgeting")
}

// Deduction from income (Tax, Pension, etc.)
model YearlyDeduction {
  id            Int    @id @default(autoincrement())
  incomeEntryId Int    @map("income_entry_id")
  name          String
  amount        Int    @default(0) // In cents
  orderIndex    Int    @default(0) @map("order_index")
  createdAt     Int    @map("created_at")
  updatedAt     Int    @map("updated_at")

  incomeEntry YearlyIncomeEntry @relation(fields: [incomeEntryId], references: [id], onDelete: Cascade)

  @@index([incomeEntryId])
  @@map("yearly_deductions")
  @@schema("budgeting")
}

// Budget section (Living Essentials 70%, Non-Essentials 20%, Savings 10%)
model YearlySection {
  id             Int    @id @default(autoincrement())
  yearlyBudgetId Int    @map("yearly_budget_id")
  type           SectionType
  name           String // Display name
  targetPercent  Int    @default(70) @map("target_percent") // 70, 20, or 10
  orderIndex     Int    @default(0) @map("order_index")
  createdAt      Int    @map("created_at")
  updatedAt      Int    @map("updated_at")

  yearlyBudget YearlyBudget     @relation(fields: [yearlyBudgetId], references: [id], onDelete: Cascade)
  categories   YearlyCategory[]

  @@index([yearlyBudgetId])
  @@map("yearly_sections")
  @@schema("budgeting")
}

// Category within a section (can have parent for 2-level nesting)
model YearlyCategory {
  id         Int    @id @default(autoincrement())
  sectionId  Int    @map("section_id")
  parentId   Int?   @map("parent_id") // For subcategories (null = top-level)
  name       String
  orderIndex Int    @default(0) @map("order_index")
  createdAt  Int    @map("created_at")
  updatedAt  Int    @map("updated_at")

  section  YearlySection         @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  parent   YearlyCategory?       @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children YearlyCategory[]      @relation("CategoryHierarchy")
  entries  YearlyCategoryEntry[]

  @@index([sectionId])
  @@index([parentId])
  @@map("yearly_categories")
  @@schema("budgeting")
}

// Monthly entry for a category (amount + paid status)
model YearlyCategoryEntry {
  id         Int     @id @default(autoincrement())
  categoryId Int     @map("category_id")
  month      Int     // 1-12
  amount     Int     @default(0) // In cents
  isPaid     Boolean @default(false) @map("is_paid")
  createdAt  Int     @map("created_at")
  updatedAt  Int     @map("updated_at")

  category YearlyCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@unique([categoryId, month])
  @@map("yearly_category_entries")
  @@schema("budgeting")
}
